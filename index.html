<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Extintores</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{ --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b; --accent:#0b6efd; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
  [data-theme="dark"]{ --bg:#0b1220; --card:#071428; --text:#e6eef8; --muted:#9fb3d3; --accent:#4aa3ff; --ok:#34d399; --warn:#fbbf24; --bad:#fb7185; }
  html,body{ height:100%; margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--text); }
  header{ padding:12px 18px; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(90deg,var(--accent),#7aa7ff); color:white; }
  .container{ max-width:1200px; margin:18px auto; padding:0 12px; }
  .card{ background:var(--card); border-radius:12px; padding:14px; box-shadow:0 8px 30px rgba(2,6,23,0.08); margin-bottom:12px; }
  .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
  .btn{ background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  input,select,textarea{ padding:8px 10px; border-radius:8px; border:1px solid #e6edf6; width:100%; box-sizing:border-box; background:transparent; color:inherit; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  th,td{ padding:8px 10px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:left; vertical-align:middle; }
  .flex{ display:flex; gap:8px; align-items:center; }
  .hidden{ display:none; }
  .img-preview{ max-width:140px; max-height:100px; object-fit:cover; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
  @media (max-width:1024px){ .grid{ grid-template-columns:repeat(2,1fr);} }
  @media (max-width:640px){ .grid{ grid-template-columns:repeat(1,1fr);} table{ font-size:12px; } header{ flex-direction:column; align-items:flex-start; gap:8px; } }
</style>
</head>
<body data-theme="light">
<header>
  <div><strong>Controle de Extintores</strong><div style="font-size:12px">Painel de Gestão</div></div>
  <div style="display:flex;gap:8px;align-items:center">
    <div id="userArea"></div>
    <button id="themeToggle" class="btn" style="background:#fff;color:var(--accent)">Tema</button>
  </div>
</header>

<div class="container">
  <div id="login" class="card" style="max-width:420px;margin:18px auto;">
    <h3>Entrar</h3>
    <label>Nome</label><input id="loginName" />
    <label>Senha</label><input id="loginPass" type="password" />
    <div style="height:8px"></div>
    <div class="flex" style="justify-content:space-between">
      <button id="btnLogin" class="btn">Entrar</button>
      <div style="align-self:center;color:#fff;background:var(--accent);padding:6px 8px;border-radius:6px">Senha padrão: <strong style="margin-left:6px">SCIJOI@2026</strong></div>
    </div>
    <div id="loginMsg" style="color:var(--bad);margin-top:8px"></div>
  </div>

  <div id="app" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">Painel</h2>
          <div style="font-size:13px;color:var(--muted)">Controle Em Uso ↔ Depósito</div>
        </div>
        <div class="flex">
          <button id="btnNovo" class="btn">Novo (Em Uso)</button>
          <button id="btnNovoDep" class="btn">Novo (Depósito)</button>
          <button id="btnPermuta" class="btn">Permutar</button>
          <button id="btnLogout" class="btn">Sair</button>
        </div>
      </div>
    </div>

    <div class="grid" id="stats"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="flex:1;display:flex;gap:8px">
          <input id="filterSearch" placeholder="Buscar..." />
          <select id="filterTipo"><option value="">Todos os Tipos</option></select>
          <select id="filterStatus"><option value="">Todos Status</option><option>Conforme</option><option>Não conforme</option><option>Vencido</option><option>Operacional</option><option>Não operacional</option></select>
          <button id="btnFiltrar" class="btn" style="background:#eee;color:#111">Filtrar</button>
          <button id="btnClear" class="btn" style="background:#eee;color:#111">Limpar</button>
        </div>
        <div class="flex">
          <button id="btnExportCSV" class="btn" style="background:#fff;color:var(--accent)">Export CSV</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Extintores em Uso</h3>
      <div style="overflow:auto;max-height:360px">
        <table id="tableUso"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card">
      <h3>Depósito</h3>
      <div style="overflow:auto;max-height:300px">
        <table id="tableDep"><thead></thead><tbody></tbody></table>
      </div>
    </div>

  </div>
</div>

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* CONFIG */
const API_URL = 'https://script.google.com/macros/s/AKfycbz6dUt-tCk0HM1sFU2eCOEszuNk_hXw6BPnKhFpLXDRB1Ppksy4HpfYRmbQIXsrfOYJ/exec'; // <<-- SUBSTITUA com a URL do WebApp
const LS_TOKEN = 'ce_session_token';
const LS_USER = 'ce_user';

/* HELPERS */
function apiPost(payload){ return fetch(API_URL, {method:'POST', body: JSON.stringify(payload)}).then(r=>r.json()); }
function setToken(t){ if(!t) localStorage.removeItem(LS_TOKEN); else localStorage.setItem(LS_TOKEN, t); }
function getToken(){ return localStorage.getItem(LS_TOKEN); }
function setUser(u){ if(!u) localStorage.setItem(LS_USER, u); else localStorage.removeItem(LS_USER); }
function getUser(){ return localStorage.getItem(LS_USER); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* THEME */
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme') || 'light';
  document.body.setAttribute('data-theme', cur==='light' ? 'dark' : 'light');
});

/* AUTH */
async function tryAutoLogin(){
  const token = getToken();
  if(!token){ showLogin(); return; }
  const res = await apiPost({acao:'validar', token});
  if(res && res.ok) { onLoginSuccess(res.usuario); } else { setToken(null); setUser(null); showLogin(); }
}
async function doLogin(){
  const nome = document.getElementById('loginName').value.trim();
  const senha = document.getElementById('loginPass').value;
  const res = await apiPost({acao:'login', nome, senha});
  if(res && res.ok){ setToken(res.token); localStorage.setItem(LS_USER, res.usuario); onLoginSuccess(res.usuario); } else { document.getElementById('loginMsg').textContent = res.error || 'Erro'; }
}
document.getElementById('btnLogin').addEventListener('click', doLogin);
document.getElementById('btnLogout').addEventListener('click', async ()=>{
  await apiPost({acao:'logout', token: getToken()});
  setToken(null); localStorage.removeItem(LS_USER);
  showLogin();
});
function showLogin(){ document.getElementById('login').style.display = ''; document.getElementById('app').classList.add('hidden'); }
function onLoginSuccess(user){
  document.getElementById('login').style.display = 'none';
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('userArea').innerHTML = `<strong>${user}</strong>`;
  loadAll();
}

/* DATA */
let dataUso = [], dataDep = [];

async function loadAll(){
  const token = getToken();
  const uso = await apiPost({acao:'listar', aba:'uso', token});
  const dep = await apiPost({acao:'listar', aba:'deposito', token});
  dataUso = uso.ok ? uso.data : [];
  dataDep = dep.ok ? dep.data : [];
  renderStats(); renderTables(); populateFilters();
}

/* RENDER */
function renderStats(){
  const st = document.getElementById('stats'); st.innerHTML = '';
  const totalUso = dataUso.length; const totalDep = dataDep.length;
  const conformes = dataUso.filter(r => String(r['Situação']||'').toLowerCase().includes('conforme')).length;
  const vencidos = dataUso.filter(r => { const v = r['Validade Nível 2']; return v && new Date(v) < new Date(); }).length;
  const cards = [{t:'Em Uso', v: totalUso},{t:'No Depósito', v: totalDep},{t:'Conformes', v: conformes},{t:'Vencidos (N2)', v: vencidos}];
  cards.forEach(c=>{ const div = document.createElement('div'); div.className='card'; div.innerHTML = `<div style="font-size:13px;color:var(--muted)">${c.t}</div><div style="font-weight:700;font-size:20px">${c.v}</div>`; st.appendChild(div); });
}

function buildTable(containerId, rows){
  const table = document.getElementById(containerId);
  const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody');
  thead && thead.remove(); tbody && tbody.remove();
  const head = document.createElement('thead'); const body = document.createElement('tbody');
  if(!rows || rows.length===0){ head.innerHTML = '<tr><th>Nenhum registro</th></tr>'; table.appendChild(head); table.appendChild(body); return; }
  const headers = Object.keys(rows[0]);
  let trh = '<tr>'; headers.forEach(h=> trh += `<th>${h}</th>`); trh += '<th>Ações</th></tr>'; head.innerHTML = trh;
  rows.forEach(row=>{
    let tr = '<tr>';
    headers.forEach(h=>{
      let v = row[h] || '';
      if(h === 'FotoURL' && v) v = `<img src="${v}" class="img-preview" />`;
      tr += `<td>${escapeHtml(String(v||''))}</td>`;
    });
    tr += `<td>
      <button class="btn" onclick='openEdit(${JSON.stringify(row).replace(/'/g,"\\'")})'>Editar</button>
      <button class="btn" onclick='openPermuta("${row.ID}", "${containerId}")'>Permutar</button>
      <button class="btn" onclick='downloadPDF(${JSON.stringify(row).replace(/'/g,"\\'")})'>PDF</button>
    </td></tr>`;
    body.insertAdjacentHTML('beforeend', tr);
  });
  table.appendChild(head); table.appendChild(body);
}
function renderTables(){ buildTable('tableUso', dataUso); buildTable('tableDep', dataDep); }
function populateFilters(){ const sel = document.getElementById('filterTipo'); sel.innerHTML = '<option value="">Todos os Tipos</option>'; const tipos = {}; dataUso.concat(dataDep).forEach(r => { if(r['Tipo/kg']) tipos[r['Tipo/kg']] = true; }); Object.keys(tipos).forEach(t=> sel.insertAdjacentHTML('beforeend', `<option>${t}</option>`)); }

/* FILTER */
document.getElementById('btnFiltrar').addEventListener('click', ()=>{
  const q = document.getElementById('filterSearch').value.toLowerCase();
  const tipo = document.getElementById('filterTipo').value;
  const status = document.getElementById('filterStatus').value;
  const fUso = dataUso.filter(r => { const s = JSON.stringify(Object.values(r)).toLowerCase(); if(q && s.indexOf(q)===-1) return false; if(tipo && (r['Tipo/kg']||'') !== tipo) return false; if(status && (String(r['Situação']||r['Status']||'') !== status)) return false; return true; });
  const fDep = dataDep.filter(r => { const s = JSON.stringify(Object.values(r)).toLowerCase(); if(q && s.indexOf(q)===-1) return false; if(tipo && (r['Tipo/kg']||'') !== tipo) return false; if(status && (String(r['Situação']||r['Status']||'') !== status)) return false; return true; });
  buildTable('tableUso', fUso); buildTable('tableDep', fDep);
});
document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('filterSearch').value=''; document.getElementById('filterTipo').value=''; document.getElementById('filterStatus').value=''; renderTables(); });

/* MODALS & CRUD minimal (reuses browser prompt for speed) */
function openEdit(row){
  // Simple prompt-based edit for speed (you can replace with a full modal)
  const token = getToken();
  if(!token){ alert('Sessão expirada'); return; }
  const data = {}; const keys = Object.keys(row);
  keys.forEach(k=>{
    if(k === 'ID') return; // ID not editable
    const val = prompt('Editar ' + k, row[k] || '');
    if(val !== null) data[k] = val;
  });
  apiPost({acao:'editar', token, id: row.ID, data}).then(res=>{ if(res.ok){ alert('Editado'); loadAll(); } else alert(res.error || 'Erro'); });
}

function openPermuta(id, origin){
  const idUso = origin === 'tableUso' ? id : prompt('ID (Em Uso):', '');
  const idDep = origin === 'tableDep' ? id : prompt('ID (Depósito):', '');
  if(!idUso || !idDep) return alert('IDs necessários');
  const situacao_uso = prompt('Situação (uso)', 'Conforme') || 'Conforme';
  const situacao_deposito = prompt('Situação (dep)', 'Operacional') || 'Operacional';
  apiPost({acao:'permuta', token: getToken(), id_uso: idUso, id_deposito: idDep, situacao_uso, situacao_deposito}).then(res=>{ if(res.ok){ alert('Permuta OK'); loadAll(); } else alert(res.error || 'Erro na permuta'); });
}

/* NEW entries with file upload */
document.getElementById('btnNovo').addEventListener('click', async ()=>{
  const token = getToken(); if(!token) { alert('Sessão expirada'); return; }
  const data = {};
  data['Número'] = prompt('Número'); data['Edificação'] = prompt('Edificação'); data['Local'] = prompt('Local');
  data['Tipo/kg'] = prompt('Tipo/kg'); data['Substituto?'] = prompt('Substituto?'); data['Situação'] = prompt('Situação','Conforme');
  data['Não conformidade'] = prompt('Não conformidade',''); data['Observação'] = prompt('Observação','');
  data['Fabricação'] = prompt('Fabricação',''); data['Validade Nível 2'] = prompt('Validade Nível 2 (YYYY-MM-DD)','');
  data['Validade Nível 3'] = prompt('Validade Nível 3 (YYYY-MM-DD)',''); data['Equipe'] = prompt('Equipe',''); data['Responsável'] = prompt('Responsável','');
  // optional file prompt: user pastes dataURI or skip
  const up = confirm('Deseja fazer upload de foto? (Arquivo será pedido em outra janela)');
  if(up){
    alert('Escolha um arquivo de imagem e cole aqui como data URL (ou cancele). Em navegadores comuns, é mais simples usar a versão com modal.' );
    const base64 = prompt('Cole a dataURL (ex: data:image/jpeg;base64,...)');
    if(base64){ const r = await apiPost({acao:'uploadfoto', token, base64, targetId: null}); if(r.ok) data['FotoURL'] = r.url; }
  }
  const res = await apiPost({acao:'cadastrar', token, aba:'uso', data});
  if(res.ok) { alert('Cadastrado: ' + res.id); loadAll(); } else alert(res.error || 'Erro');
});

document.getElementById('btnNovoDep').addEventListener('click', async ()=>{
  const token = getToken(); if(!token) { alert('Sessão expirada'); return; }
  const data = {};
  data['Tipo/kg'] = prompt('Tipo/kg'); data['Status'] = prompt('Status (Operacional/Não operacional/Vencido)','Operacional');
  const base64 = prompt('Cole dataURL para foto (opcional)');
  if(base64){ const r = await apiPost({acao:'uploadfoto', token, base64, targetId: null}); if(r.ok) data['FotoURL'] = r.url; }
  const res = await apiPost({acao:'cadastrar', token, aba:'deposito', data});
  if(res.ok) { alert('Cadastrado depósito: ' + res.id); loadAll(); } else alert(res.error || 'Erro');
});

/* PDF generation (basic) */
async function downloadPDF(row){
  const container = document.createElement('div'); container.style.padding='20px'; container.style.width='800px'; container.style.background='white'; container.style.color='black';
  container.innerHTML = `<h2>Extintor ${row.ID}</h2><div><strong>Número:</strong> ${row['Número']||''}</div><div><strong>Local:</strong> ${row['Local']||''}</div><div><strong>Tipo/kg:</strong> ${row['Tipo/kg']||''}</div><div><strong>Situação:</strong> ${row['Situação']||row['Status']||''}</div><div style="margin-top:10px">${row['FotoURL']?`<img src="${row['FotoURL']}" style="max-width:360px">`:''}</div>`;
  document.body.appendChild(container);
  const canvas = await html2canvas(container, {scale:2});
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:'portrait', unit:'px', format:[canvas.width, canvas.height]});
  pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
  pdf.save(`${row.ID}.pdf`);
  document.body.removeChild(container);
}

/* INIT */
tryAutoLogin();

</script>
</body>
</html>
