<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Extintores</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  /* ====== BASIC THEME (light/dark) ====== */
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b;
    --accent:#0b6efd; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#071428; --text:#e6eef8; --muted:#9fb3d3;
    --accent:#4aa3ff; --ok:#34d399; --warn:#fbbf24; --bad:#fb7185;
  }
  html,body{ height:100%; margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--text); }
  header{ padding:12px 18px; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(90deg,var(--accent),#7aa7ff); color:white; }
  .container{ max-width:1200px; margin:18px auto; padding:0 12px; }
  .card{ background:var(--card); border-radius:12px; padding:14px; box-shadow:0 8px 30px rgba(2,6,23,0.08); margin-bottom:12px; }
  .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
  .grid-cols-3{ grid-template-columns:repeat(3,1fr); }
  .grid-cols-2{ grid-template-columns:repeat(2,1fr); }
  .btn{ background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn-muted{ background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.06); }
  input,select,textarea{ padding:8px 10px; border-radius:8px; border:1px solid #e6edf6; width:100%; box-sizing:border-box; background:transparent; color:inherit; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  th,td{ padding:8px 10px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:left; vertical-align:middle; }
  .flex{ display:flex; gap:8px; align-items:center; }
  .hidden{ display:none; }
  .login-box{ max-width:420px; margin:30px auto; }
  .badge{ padding:6px 8px; border-radius:999px; font-weight:600; font-size:12px; display:inline-block; }
  .muted{ color:var(--muted); font-size:13px; }
  .topbar-actions{ display:flex; gap:8px; align-items:center; }
  .search{ display:flex; gap:8px; align-items:center; }
  .img-preview{ max-width:140px; max-height:100px; object-fit:cover; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
  @media (max-width:1024px){ .grid{ grid-template-columns:repeat(2,1fr); } .grid-cols-3{ grid-template-columns:repeat(2,1fr);} }
  @media (max-width:640px){ .grid{ grid-template-columns:repeat(1,1fr); } table{ font-size:12px; } header{ flex-direction:column; align-items:flex-start; gap:8px; }}
</style>
</head>
<body data-theme="light">
<header>
  <div><strong>Controle de Extintores</strong><div class="muted">Painel de Gest√£o</div></div>
  <div class="topbar-actions">
    <div id="userArea" style="display:flex;align-items:center;gap:8px"></div>
    <button id="themeToggle" class="btn-muted">üåô Tema</button>
  </div>
</header>

<div class="container">
  <!-- Login -->
  <div id="login" class="card login-box hidden">
    <h3>Entrar</h3>
    <label>Nome</label><input id="loginName" />
    <label>Senha</label><input id="loginPass" type="password" />
    <div style="height:8px"></div>
    <div class="flex" style="justify-content:space-between">
      <button id="btnLogin" class="btn">Entrar</button>
      <div class="muted">Senha padr√£o: <strong>SCIJOI@2026</strong></div>
    </div>
    <div id="loginMsg" class="muted" style="margin-top:8px;color:var(--bad)"></div>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <h2 style="margin:0">Painel</h2>
          <div class="muted">Sistema de controle ‚Äî Em Uso ‚Üî Dep√≥sito</div>
        </div>
        <div class="flex">
          <button id="btnNovo" class="btn btn-muted">Novo (Em Uso)</button>
          <button id="btnNovoDep" class="btn btn-muted">Novo (Dep√≥sito)</button>
          <button id="btnPermuta" class="btn">Permutar</button>
          <button id="btnLogout" class="btn">Sair</button>
        </div>
      </div>
    </div>

    <div class="grid" id="stats"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="search" style="flex:1">
          <input id="filterSearch" placeholder="Buscar por N√∫mero, Local, Tipo..." />
          <select id="filterTipo"><option value="">Todos os Tipos</option></select>
          <select id="filterStatus"><option value="">Todos Status</option><option>Conforme</option><option>N√£o conforme</option><option>Vencido</option><option>Operacional</option><option>N√£o operacional</option></select>
          <button id="btnFiltrar" class="btn-muted">Filtrar</button>
          <button id="btnClear" class="btn-muted">Limpar</button>
        </div>
        <div class="flex">
          <button id="btnExportCSV" class="btn-muted">Export CSV</button>
          <button id="btnTheme" class="btn-muted">Tema</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Extintores em Uso</h3>
      <div style="overflow:auto;max-height:360px">
        <table id="tableUso"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card">
      <h3>Dep√≥sito</h3>
      <div style="overflow:auto;max-height:300px">
        <table id="tableDep"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- Modal area -->
    <div id="modal" class="card hidden" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:92%;max-width:820px;z-index:60;">
      <h3 id="modalTitle"></h3>
      <div id="modalBody"></div>
      <div style="height:10px"></div>
      <div style="text-align:right"><button id="modalClose" class="btn-muted">Fechar</button> <button id="modalSave" class="btn">Salvar</button></div>
    </div>

  </div>
</div>

<!-- External libs for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* ================== CONFIG ================== */
const API_URL = 'https://script.google.com/macros/s/AKfycbz6dUt-tCk0HM1sFU2eCOEszuNk_hXw6BPnKhFpLXDRB1Ppksy4HpfYRmbQIXsrfOYJ/exec'; // <<-- SUBSTITUA com a URL do seu Apps Script WebApp
const LS_TOKEN_KEY = 'ce_session_token';
const LS_USER_KEY = 'ce_user';
const SESSION_DAYS = parseInt(localStorage.getItem('sessao_dias')||30,10);

/* ================ HELPERS ================ */
function apiPost(payload){ return fetch(API_URL, {method:'POST', body: JSON.stringify(payload)}).then(r=>r.json()); }
function setToken(t){ if(!t) localStorage.removeItem(LS_TOKEN_KEY); else localStorage.setItem(LS_TOKEN_KEY, t); }
function getToken(){ return localStorage.getItem(LS_TOKEN_KEY); }
function setUser(u){ if(!u) localStorage.removeItem(LS_USER_KEY); else localStorage.setItem(LS_USER_KEY, u); }
function getUser(){ return localStorage.getItem(LS_USER_KEY); }
function formatDateForInput(d){ if(!d) return ''; const dt = new Date(d); if(isNaN(dt)) return ''; const y=dt.getFullYear(); const m=('0'+(dt.getMonth()+1)).slice(-2); const day=('0'+dt.getDate()).slice(-2); return `${y}-${m}-${day}`; }
function parseDateFromInput(s){ if(!s) return ''; const dt = new Date(s); if(isNaN(dt)) return ''; return dt.toISOString().slice(0,10); }

/* ================ UI REFS ================ */
const loginEl = document.getElementById('login');
const appEl = document.getElementById('app');
const userArea = document.getElementById('userArea');
const loginMsg = document.getElementById('loginMsg');

/* ================ THEME ================ */
const themeBtn = document.getElementById('themeToggle');
themeBtn.addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme') || 'light';
  const nxt = cur==='light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', nxt);
});

/* ================ AUTH ================ */
async function tryAutoLogin(){
  const token = getToken();
  if(!token){ showLogin(); return; }
  const res = await apiPost({acao:'validar', token});
  if(res && res.ok){ onLoginSuccess(res.usuario); } else { setToken(null); setUser(null); showLogin(); }
}
async function doLogin(){
  const nome = document.getElementById('loginName').value.trim();
  const senha = document.getElementById('loginPass').value;
  loginMsg.textContent = '';
  const res = await apiPost({acao:'login', nome, senha});
  if(res && res.ok){ setToken(res.token); setUser(res.usuario); onLoginSuccess(res.usuario); }
  else { loginMsg.textContent = (res && res.error) ? res.error : 'Erro no login'; }
}
function onLoginSuccess(usuario){
  loginEl.classList.add('hidden');
  appEl.classList.remove('hidden');
  userArea.innerHTML = `<div class="muted">Usu√°rio:</div> <strong>${usuario}</strong>`;
  loadAll();
}
document.getElementById('btnLogin').addEventListener('click', doLogin);
document.getElementById('btnLogout').addEventListener('click', async ()=>{
  const token = getToken();
  await apiPost({acao:'logout', token});
  setToken(null); setUser(null);
  showLogin();
});
function showLogin(){ loginEl.classList.remove('hidden'); appEl.classList.add('hidden'); }

/* ================ LOAD DATA ================ */
let dataUso = [], dataDep = [];

async function loadAll(){
  const token = getToken();
  const usoRes = await apiPost({acao:'listar', aba:'uso', token});
  const depRes = await apiPost({acao:'listar', aba:'deposito', token});
  dataUso = usoRes.ok ? usoRes.data : [];
  dataDep = depRes.ok ? depRes.data : [];
  renderStats();
  renderTables();
  populateFilters();
}

/* ================ RENDER ================ */
function renderStats(){
  const st = document.getElementById('stats');
  st.innerHTML = '';
  const totalUso = dataUso.length;
  const totalDep = dataDep.length;
  const conformes = dataUso.filter(r=> String(r['Situa√ß√£o']||'').toLowerCase().includes('conforme')).length;
  const vencidos = dataUso.filter(r=>{
    const v = r['Validade N√≠vel 2'];
    return v && new Date(v) < new Date();
  }).length;
  const cards = [
    {t:'Em Uso', v: totalUso},
    {t:'No Dep√≥sito', v: totalDep},
    {t:'Conformes', v: conformes},
    {t:'Vencidos (N2)', v: vencidos},
  ];
  cards.forEach(c=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="font-size:13px" class="muted">${c.t}</div><div style="font-size:20px;font-weight:700">${c.v}</div>`;
    st.appendChild(d);
  });
}

function renderTables(){
  // USO
  const tableUso = document.getElementById('tableUso');
  const theadUso = tableUso.querySelector('thead'); const tbodyUso = tableUso.querySelector('tbody');
  theadUso.innerHTML = ''; tbodyUso.innerHTML = '';
  if(dataUso.length===0){ theadUso.innerHTML = '<tr><th>Nenhum registro</th></tr>'; return; }
  const headers = Object.keys(dataUso[0]);
  // build header row
  let trh = '<tr>';
  headers.forEach(h=>{ trh += `<th>${h}</th>`; });
  trh += '<th>A√ß√µes</th></tr>';
  theadUso.innerHTML = trh;
  // rows
  dataUso.forEach(row=>{
    let tr = '<tr>';
    headers.forEach(h=>{
      let v = row[h] || '';
      if(h==='FotoURL' && v) v = `<img src="${v}" class="img-preview" />`;
      tr += `<td>${escapeHtml(String(v||''))}</td>`;
    });
    tr += `<td>
      <button class="btn-muted" onclick='openEdit(${JSON.stringify(row).replace(/'/g,"\\'")})'>Editar</button>
      <button class="btn" onclick='openPermuta("${row.ID}", "uso")'>Permutar</button>
      <button class="btn-muted" onclick='downloadPDF(${JSON.stringify(row).replace(/'/g,"\\'")})'>PDF</button>
    </td></tr>`;
    tbodyUso.insertAdjacentHTML('beforeend', tr);
  });

  // DEPOSITO
  const tableDep = document.getElementById('tableDep');
  const theadDep = tableDep.querySelector('thead'); const tbodyDep = tableDep.querySelector('tbody');
  theadDep.innerHTML = ''; tbodyDep.innerHTML = '';
  if(dataDep.length===0){ theadDep.innerHTML = '<tr><th>Nenhum registro</th></tr>'; return; }
  const headersDep = Object.keys(dataDep[0]);
  let trh2 = '<tr>';
  headersDep.forEach(h=>{ trh2 += `<th>${h}</th>`; });
  trh2 += '<th>A√ß√µes</th></tr>';
  theadDep.innerHTML = trh2;
  dataDep.forEach(row=>{
    let tr = '<tr>';
    headersDep.forEach(h=>{
      let v = row[h] || '';
      if(h==='FotoURL' && v) v = `<img src="${v}" class="img-preview" />`;
      tr += `<td>${escapeHtml(String(v||''))}</td>`;
    });
    tr += `<td>
      <button class="btn-muted" onclick='openEdit(${JSON.stringify(row).replace(/'/g,"\\'")})'>Editar</button>
      <button class="btn" onclick='openPermuta("${row.ID}", "dep")'>Escolher</button>
      <button class="btn-muted" onclick='downloadPDF(${JSON.stringify(row).replace(/'/g,"\\'")})'>PDF</button>
    </td></tr>`;
    tbodyDep.insertAdjacentHTML('beforeend', tr);
  });
}

function escapeHtml(text){
  return text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ================ FILTERS ================ */
function populateFilters(){
  const sel = document.getElementById('filterTipo');
  sel.innerHTML = '<option value="">Todos os Tipos</option>';
  const tipos = {};
  dataUso.concat(dataDep).forEach(r => { if(r['Tipo/kg']) tipos[r['Tipo/kg']] = true; });
  Object.keys(tipos).forEach(t => sel.insertAdjacentHTML('beforeend', `<option>${t}</option>`));
}
document.getElementById('btnFiltrar').addEventListener('click', async ()=>{
  const q = document.getElementById('filterSearch').value.toLowerCase();
  const tipo = document.getElementById('filterTipo').value;
  const status = document.getElementById('filterStatus').value;
  // apply simple filter
  const fUso = dataUso.filter(r => {
    const s = JSON.stringify(Object.values(r)).toLowerCase();
    if(q && s.indexOf(q)===-1) return false;
    if(tipo && (r['Tipo/kg']||'') !== tipo) return false;
    if(status && (String(r['Situa√ß√£o']||r['Status']||'') !== status)) return false;
    return true;
  });
  const fDep = dataDep.filter(r => {
    const s = JSON.stringify(Object.values(r)).toLowerCase();
    if(q && s.indexOf(q)===-1) return false;
    if(tipo && (r['Tipo/kg']||'') !== tipo) return false;
    if(status && (String(r['Situa√ß√£o']||r['Status']||'') !== status)) return false;
    return true;
  });
  // render filtered
  renderFiltered(fUso, fDep);
});
document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('filterSearch').value=''; document.getElementById('filterTipo').value=''; document.getElementById('filterStatus').value=''; renderTables(); });

function renderFiltered(fUso, fDep){
  // simplified rendering for filtered results
  const tableUso = document.getElementById('tableUso'); const tbodyUso = tableUso.querySelector('tbody'); tbodyUso.innerHTML='';
  if(fUso.length===0) tbodyUso.innerHTML = '<tr><td colspan="99">Nenhum registro</td></tr>';
  fUso.forEach(row=>{
    let tr = '<tr>';
    Object.keys(row).forEach(h=> tr += `<td>${escapeHtml(String(row[h]||''))}</td>`);
    tr += `<td><button class="btn-muted" onclick='openEdit(${JSON.stringify(row).replace(/'/g,"\\'")})'>Editar</button> <button class="btn" onclick='openPermuta("${row.ID}", "uso")'>Permutar</button></td></tr>`;
    tbodyUso.insertAdjacentHTML('beforeend', tr);
  });
  const tableDep = document.getElementById('tableDep'); const tbodyDep = tableDep.querySelector('tbody'); tbodyDep.innerHTML='';
  if(fDep.length===0) tbodyDep.innerHTML = '<tr><td colspan="99">Nenhum registro</td></tr>';
  fDep.forEach(row=>{
    let tr = '<tr>';
    Object.keys(row).forEach(h=> tr += `<td>${escapeHtml(String(row[h]||''))}</td>`);
    tr += `<td><button class="btn-muted" onclick='openEdit(${JSON.stringify(row).replace(/'/g,"\\'")})'>Editar</button> <button class="btn" onclick='openPermuta("${row.ID}", "dep")'>Escolher</button></td></tr>`;
    tbodyDep.insertAdjacentHTML('beforeend', tr);
  });
}

/* ================ MODALS: CRUD & PERMUTA ================ */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');
const modalSave = document.getElementById('modalSave');

modalClose.addEventListener('click', ()=> modal.classList.add('hidden'));

let modalMode = '';
let modalContext = null;

document.getElementById('btnNovo').addEventListener('click', ()=> openCreateModal('uso'));
document.getElementById('btnNovoDep').addEventListener('click', ()=> openCreateModal('dep'));
document.getElementById('btnPermuta').addEventListener('click', ()=> openPermutaModal());

function openCreateModal(tipo){
  modalMode = 'create';
  modalContext = tipo;
  modalTitle.textContent = tipo==='uso' ? 'Cadastrar Extintor (Em Uso)' : 'Cadastrar Extintor (Dep√≥sito)';
  let html = '';
  if(tipo==='uso'){
    const fields = ['N√∫mero','Edifica√ß√£o','Local','Tipo/kg','Substituto?','Situa√ß√£o','N√£o conformidade','Observa√ß√£o','Fabrica√ß√£o','Validade N√≠vel 2','Validade N√≠vel 3','Equipe','Respons√°vel'];
    fields.forEach(f=> html += `<label>${f}</label><input data-key="${f}" />`);
    html += `<label>Foto</label><input type="file" id="fileFoto" accept="image/*" /> <div id="fotoPreview"></div>`;
  } else {
    html += `<label>Tipo/kg</label><input data-key="Tipo/kg" />`;
    html += `<label>Status</label><select data-key="Status"><option>Operacional</option><option>N√£o operacional</option><option>Vencido</option></select>`;
    html += `<label>Foto</label><input type="file" id="fileFoto" accept="image/*" /> <div id="fotoPreview"></div>`;
  }
  modalBody.innerHTML = html;
  // file preview handling
  const fileEl = modal.querySelector('#fileFoto');
  if(fileEl){
    fileEl.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> {
        const img = `<img src="${reader.result}" style="max-width:160px;max-height:120px;border-radius:8px" />`;
        document.getElementById('fotoPreview').innerHTML = img;
      };
      reader.readAsDataURL(f);
    });
  }
  modal.classList.remove('hidden');
}

modalSave.addEventListener('click', async ()=>{
  const token = getToken();
  if(!token){ alert('Sess√£o expirada'); showLogin(); return; }
  if(modalMode==='create'){
    const inputs = modalBody.querySelectorAll('[data-key]');
    const data = {};
    inputs.forEach(i=> data[i.dataset.key] = i.value);
    // handle file if exists
    const fileEl = modalBody.querySelector('#fileFoto');
    if(fileEl && fileEl.files && fileEl.files[0]){
      const base64 = await fileToBase64(fileEl.files[0]);
      // upload image first
      const up = await apiPost({acao:'uploadfoto', token, base64});
      if(up.ok) data['FotoURL'] = up.url;
    }
    const res = await apiPost({acao:'cadastrar', token, aba: modalContext==='dep' ? 'deposito' : 'uso', data});
    if(res.ok){ modal.classList.add('hidden'); loadAll(); } else alert(res.error || 'Erro ao cadastrar');
  } else if(modalMode==='edit'){
    const inputs = modalBody.querySelectorAll('[data-key]');
    const data = {};
    inputs.forEach(i=> data[i.dataset.key] = i.value);
    // file
    const fileEl = modalBody.querySelector('#fileFoto');
    if(fileEl && fileEl.files && fileEl.files[0]){
      const base64 = await fileToBase64(fileEl.files[0]);
      const up = await apiPost({acao:'uploadfoto', token, base64, targetId: modalContext.ID});
      if(up.ok) data['FotoURL'] = up.url;
    }
    const res = await apiPost({acao:'editar', token, id: modalContext.ID, data});
    if(res.ok){ modal.classList.add('hidden'); loadAll(); } else alert(res.error || 'Erro ao editar');
  } else if(modalMode==='permuta'){
    const idUso = document.getElementById('perm_id_uso').value.trim();
    const idDep = document.getElementById('perm_id_dep').value.trim();
    if(!idUso || !idDep){ alert('Informe IDs'); return; }
    const situacao_uso = document.getElementById('perm_sit_uso').value || 'Conforme';
    const situacao_deposito = document.getElementById('perm_sit_dep').value || 'Operacional';
    const res = await apiPost({acao:'permuta', token, id_uso:idUso, id_deposito:idDep, situacao_uso, situacao_deposito});
    if(res.ok){ modal.classList.add('hidden'); loadAll(); alert('Permuta efetuada'); } else alert(res.error || 'Erro na permuta');
  }
});

/* ================ EDIT / PERMUTA helpers ================ */
function openEdit(row){
  modalMode = 'edit'; modalContext = row;
  modalTitle.textContent = 'Editar registro';
  let html = '';
  Object.keys(row).forEach(k=>{
    if(k==='FotoURL'){
      html += `<label>Foto</label><input type="file" id="fileFoto" accept="image/*" /> <div id="fotoPreview">${row[k] ? `<img src="${row[k]}" class="img-preview" />` : ''}</div>`;
    } else if(k==='Validade N√≠vel 2' || k==='Validade N√≠vel 3' || k==='Fabrica√ß√£o'){
      html += `<label>${k}</label><input data-key="${k}" value="${row[k]||''}" type="date" />`;
    } else if(k==='Status' || k==='Situa√ß√£o'){
      html += `<label>${k}</label><input data-key="${k}" value="${row[k]||''}" />`;
    } else if(k==='ID'){
      html += `<label>${k}</label><input data-key="${k}" value="${row[k]||''}" disabled />`;
    } else {
      html += `<label>${k}</label><input data-key="${k}" value="${row[k]||''}" />`;
    }
  });
  modalBody.innerHTML = html;
  modal.classList.remove('hidden');
}

function openPermutaModal(){
  modalMode='permuta';
  modalTitle.textContent = 'Permutar Extintor (Uso ‚Üî Dep√≥sito)';
  modalBody.innerHTML = `
    <label>ID (Em Uso)</label><input id="perm_id_uso" />
    <label>ID (Dep√≥sito)</label><input id="perm_id_dep" />
    <label>Situa√ß√£o (uso)</label><input id="perm_sit_uso" value="Conforme" />
    <label>Situa√ß√£o (dep)</label><input id="perm_sit_dep" value="Operacional" />
  `;
  modal.classList.remove('hidden');
}

function openPermuta(id, origin){
  // origin 'uso' or 'dep'
  modalMode='permuta';
  modalTitle.textContent = 'Permutar Extintor';
  const idUso = origin==='uso' ? id : '';
  const idDep = origin==='dep' ? id : '';
  modalBody.innerHTML = `
    <label>ID (Em Uso)</label><input id="perm_id_uso" value="${idUso}" />
    <label>ID (Dep√≥sito)</label><input id="perm_id_dep" value="${idDep}" />
    <label>Situa√ß√£o (uso)</label><input id="perm_sit_uso" value="Conforme" />
    <label>Situa√ß√£o (dep)</label><input id="perm_sit_dep" value="Operacional" />
  `;
  modal.classList.remove('hidden');
}

/* ================ FILE -> base64 helper ================ */
function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* ================ PDF generation ================ */
async function downloadPDF(row){
  // Create a printable card and use html2canvas + jsPDF
  const container = document.createElement('div');
  container.style.padding='20px'; container.style.width='800px'; container.style.background='white'; container.style.color='black';
  container.innerHTML = `<h2>Extintor: ${row['ID']}</h2>
    <div><strong>N√∫mero:</strong> ${row['N√∫mero']||''}</div>
    <div><strong>Edifica√ß√£o:</strong> ${row['Edifica√ß√£o']||''}</div>
    <div><strong>Local:</strong> ${row['Local']||''}</div>
    <div><strong>Tipo/kg:</strong> ${row['Tipo/kg']||''}</div>
    <div><strong>Situa√ß√£o:</strong> ${row['Situa√ß√£o']||row['Status']||''}</div>
    <div><strong>Validade N2:</strong> ${row['Validade N√≠vel 2']||''}</div>
    <div><strong>Validade N3:</strong> ${row['Validade N√≠vel 3']||''}</div>
    <div style="margin-top:10px">${ row['FotoURL'] ? `<img src="${row['FotoURL']}" style="max-width:360px;max-height:240px;border:1px solid #ddd" />` : '' }</div>
    <div style="margin-top:10px">${row['Observa√ß√£o']||''}</div>
  `;
  document.body.appendChild(container);
  const canvas = await html2canvas(container, {scale:2});
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
  pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
  pdf.save(`${row['ID']}.pdf`);
  document.body.removeChild(container);
}

/* ================ UTILITIES ================ */
document.getElementById('btnExportCSV').addEventListener('click', ()=>{
  const rows = dataUso;
  if(!rows || rows.length===0){ alert('Nenhum dado para exportar'); return; }
  const keys = Object.keys(rows[0]);
  const csv = [keys.join(',')].concat(rows.map(r => keys.map(k => `"${String(r[k]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'extintores_em_uso.csv'; a.click(); URL.revokeObjectURL(url);
});

/* ================ INIT ================ */
tryAutoLogin();

</script>
</body>
</html>
